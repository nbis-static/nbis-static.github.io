<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>[but how do i...](&lt;&gt; &quot;permalink for but how do i...&quot;) | NBIS - National Bioinformatics Infrastructure Sweden</title>

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="generator" content="GravCMS" />
    <meta name="description" content="NBIS (National Bioinformatics Infrastructure Sweden) is a distributed national research infrastructure supported by the Swedish Research Council (Vetenskapsrådet), Science for Life Laboratory, all major Swedish universities and the Knut and Alice Wallenberg Foundation, providing state-of-the-art bioinformatics to the Swedish life science researchers community. NBIS is also the Swedish contact point to the European infrastructure for biological information ELIXIR." />

    <link rel="icon" type="image/png" href="/user/themes/quark/images/favicon.png" />
    <link rel="canonical" href="http://localhost/blog/2018-02-22-nylander-awkblast.html" />

                        
            
    <link href="/assets/user/themes/quark/css-compiled/spectre.min.css" type="text/css" rel="stylesheet">
<link href="/assets/user/themes/quark/css-compiled/theme.min.css" type="text/css" rel="stylesheet">
<link href="/assets/user/themes/quark/css/custom.css" type="text/css" rel="stylesheet">
<link href="/assets/user/themes/quark/css/line-awesome.min.css" type="text/css" rel="stylesheet">

    <script src="/assets/system/assets/jquery/jquery-3.x.min.js"></script>

</head>
<body id="top" class=" header-fixed header-animated sticky-footer">
    <div id="page-wrapper">
            <section id="header" class="section">
            <section class="container grid-lg">
                <nav class="navbar">
                    <section class="navbar-section logo">
                        <a href="/" class="navbar-brand mr-10">
  <svg xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" viewBox="0 0 504 140" clip-rule="evenodd"><path d="M235.83 71.56h-7.98c-1.2 0-2.2 1-2.2 2.2V89.1l-.15.13c-4.7 3.96-10.64 6.14-16.72 6.14-14.36 0-26.04-11.68-26.04-26.04s11.68-26.04 26.04-26.04c5.58 0 10.92 1.76 15.44 5.1.87.66 2.1.57 2.86-.2l5.7-5.7c.44-.44.67-1.05.63-1.68-.02-.62-.32-1.2-.82-1.6-6.76-5.35-15.2-8.3-23.8-8.3-21.18 0-38.42 17.23-38.42 38.4 0 21.2 17.24 38.42 38.42 38.42 10.93 0 21.4-4.7 28.7-12.9.35-.4.55-.93.55-1.47v-19.6c0-1.22-.98-2.2-2.2-2.2M502.8 34.44c-.4-.6-1.1-.98-1.84-.98h-8.7c-.87 0-1.66.52-2 1.32l-24.5 56.84-24.9-56.85c-.36-.8-1.15-1.3-2.02-1.3h-8.72c-.74 0-1.44.36-1.84.98-.4.62-.48 1.4-.17 2.1l30.2 68.85c.34.8 1.13 1.32 2 1.32h11c.88 0 1.67-.53 2.02-1.33l29.66-68.87c.3-.68.22-1.47-.2-2.1"/><path d="M388.68 34.77c-.35-.8-1.14-1.32-2-1.32h-11c-.88 0-1.67.53-2.02 1.33L344 103.64c-.3.68-.22 1.47.18 2.08.4.62 1.1 1 1.84 1h8.7c.86 0 1.66-.53 2-1.33l24.5-56.86 24.9 56.86c.36.8 1.15 1.32 2.02 1.32h8.72c.74 0 1.44-.38 1.84-1 .4-.62.47-1.4.17-2.1l-30.2-68.85zM309.2 81.52l.47-.22c8.68-4.2 14.28-13.1 14.28-22.67 0-13.88-11.3-25.18-25.17-25.18H266.9c-1.2 0-2.2 1-2.2 2.2v68.86c0 1.23 1 2.22 2.2 2.22h8c1.2 0 2.2-1 2.2-2.2V45.8h21.68c7.05 0 12.8 5.75 12.8 12.8 0 5.9-4 11-9.73 12.42-1.04.26-2.07.4-3.07.4h-7.98c-.83 0-1.6.46-1.96 1.2-.38.73-.3 1.62.2 2.3l22.6 30.87c.42.58 1.08.92 1.78.92h9.9c.84 0 1.6-.47 1.97-1.2.37-.75.3-1.64-.2-2.3l-15.9-21.7zM107.2 80.97c-7.26-4.8-11.4-8.85-15.02-16.1-2.47 4.97-8.24 12.37-17.96 18.2-4.86 15.1-27.96 44-35.43 39.9-2.22-1.2-2.64-2.8-2.15-4.45.54-4.13 9.08-13.62 9.08-13.62s.18 2 2.92 6.18c-3.6-11.2 5.96-25.03 8.5-29.73 3.98-1.27 4.27-6.4 4.27-6.4.26-7.9-3.28-13.63-6.7-17.05 2.46 3 3.25 7.54 3.37 11.7v.02c0 .47 0 .93 0 1.4-.12 3.43-1.16 8.18-3.38 8.18v.03c-2.28-.1-5.1.4-7.63 1.18l-5.6 1.34s2.98-.13 4.6 1.25c-1.8 2.9-5.78 6.53-10.22 8.58-6.45 3-8.3-2.96-5.03-6.84.8-.94 1.62-1.74 2.38-2.4-.5-.5-.8-1.2-.88-2.06 0 0 0 0 0-.02-.46-1.97-.2-4.54 2.6-8.62.54-.86 1.2-1.75 2-2.65.02-.04.04-.07.07-.1.03-.04.07-.08.1-.12.02-.02.04-.04.06-.06.2-.23.42-.45.64-.67 3.34-3.4 8.6-6.96 16.9-10.15C64.4 43.68 67.94 41 67.94 41c1.07-1.1 2.94-2.45 3.63-2.8-5.05-8.77-6.07-21.15-4.75-24.5-.1.2-.2.38-.3.57.5-1.14.83-1.5 1.34-2.1 1.38-1.64 6.06-2.5 7.74.96.9 1.84 1.06 4.23 1.03 6.02-3.7-.2-7.06 4.04-7.06 4.04s3.07-1.46 6.88-1.5c0 0 1 .9 2.28 2.56-1.7 3.2-4.52 10.02-2.5 17.16.35 1.4.86 2.62 1.5 3.65.02.05.04.1.07.14.05.07.1.13.14.2 3.37 5.06 9.54 5.66 9.54 5.66-2.9-1.45-5.27-3.76-6.8-6.56-.82-1.5-1.3-2.77-1.6-3.77-1.64-6.3.77-10 2.14-12.47 3.17-4.9 8.95-7.9 15.15-7.18 8.72 1 14.97 8.86 13.98 17.57-.6 5.32-3.78 9.72-8.15 12.12 1.05 2.84-.07 6.28-.07 6.28 2.64 3.32 2.76 5.23 2.67 7-3.36-.55-6.62 1.7-6.62 1.7s6.48-1.53 10.24 1.82c2.44 2.64 4.08 5 5.05 6.77 1.4 2.5 7.86 2.68 7.12 7.2-.74 4.5-5.68 4.53-13.4-.57M69.56 0C31.15 0 0 31.15 0 69.57c0 38.42 31.15 69.57 69.57 69.57 38.42 0 69.57-31.15 69.57-69.57C139.14 31.15 108 0 69.57 0M73.8 51.7c.8-.82.8-2.14 0-2.95-.82-.82-2.14-.82-2.95 0-.82.8-.82 2.13 0 2.94.8.8 2.13.8 2.95 0M66.45 53.15c-.82.8-.82 2.13 0 2.95.8.8 2.13.8 2.94 0 .8-.82.8-2.14 0-2.95-.82-.8-2.14-.8-2.95 0"/><path d="M79.23 54.23c-1.27-1.27-3.34-1.27-4.6 0l-2.72 2.7c-1.27 1.3-1.27 3.35 0 4.63l3 2.97c1.26 1.28 3.32 1.28 4.6 0l2.7-2.7c1.28-1.28 1.28-3.35 0-4.62l-2.97-2.97zM95.76 41.44c-2.15-2.57 1.87-7.25 4.4-4.46 4.64 5.15-2.25 7.04-4.4 4.46m9.24 2.7c3.45-6.56-1.42-10.4-4.77-13.53-5.36-5.03-10.7-7.2-16.8-.23-6.1 6.98-2.24 15.07 3.35 19.06 5.58 4 14.78 1.25 18.22-5.3"/></svg></a>
                    </section>
                    <section class="navbar-section desktop-menu">

                        <nav class="dropmenu animated">
                                                    
<ul >
        
</ul>

                                                </nav>

                        
                    </section>
                </nav>
            </section>
        </section>
        <div class="mobile-menu">
            <div class="button_container" id="toggle">
                <span class="top"></span>
                <span class="middle"></span>
                <span class="bottom"></span>
            </div>
        </div>
    
    
        <section id="start">
                    <section id="body-wrapper" class="section">
                <section class="container grid-lg">
                                            
                                            <p>February 22, 2018</p>
<p><a href="/blog/2018-02-22-nylander-awkblast.html/&lt;https://twitter.com/share?url=https%3A%2F%2Fnbis.se%2Fblog%2F2018-02-22-nylander-awkblast.html%3E" title="Tweet it!"><img src="/assets/img/logos/icon-share-twitter.png" alt="" /></a></p>
<h3><a href="/blog/2018-02-22-nylander-awkblast.html/&lt;&gt;" title="Permalink for But how do I...">But how do I...</a></h3>
<p>By Johan A.A. Nylander</p>
<p><strong>... get the top hits from BLAST outfmt 6?</strong></p>
<img src='assets/img/awkblast.png' width='100%' alt='awkblast' />
<p>Finding simple solutions for challenging problems always gives me a sense of joy and sometimes even relief: no need to spend a lot of time when you can solve it quickly, and then preferably with minimum code.</p>
<p>Arguably one of the most elegant solutions I’ve come across, is how to use the <a href="/blog/2018-02-22-nylander-awkblast.html/&lt;https://en.wikipedia.org/wiki/AWK&gt;">AWK</a> programming language for extracting the top hits from the output of a blast search:</p>
<pre><code>awk '!x[$1]++'</code></pre>
<p>This expression might require some background and further explanations.</p>
<h2>Background</h2>
<p>If you work long enough in bioinformatics, sooner or later you will be faced with the need of “<a href="/blog/2018-02-22-nylander-awkblast.html/&lt;https://www.ncbi.nlm.nih.gov/guide/howto/run-blast-local/&gt;">running blast locally</a>” (or “run a stand-alone blast”). This simply mean that instead of doing your similarity search by uploading your query sequence to a web page (e.g. <a href="/blog/2018-02-22-nylander-awkblast.html/&lt;https://blast.ncbi.nlm.nih.gov/Blast.cgi&gt;">NBCI’s BLAST portal</a>), you run your search algorithm locally on your own computer and using your own data base.</p>
<p>The main benefit from running searches locally is that you can taylor your data base to your needs, and also manipulate the output so it fits exactly in down stream computational work flows.</p>
<p>Dealing with the latter is perhaps also where you face the first obstacle. Instead of having the results packaged and displayed nicely in the web browser, you have to read (parse) potentially very large files and manipulate the output.</p>
<p>If we take the output from a blast search as our example, the format might look something like this:</p>
<pre><code>Apa PBF38905.1  92.115  279 22  0   2   838 48  326 0.0 518
Apa PBF45636.1  92.115  279 22  0   2   838 48  326 0.0 518
Apa PBG14713.1  92.115  279 22  0   2   838 48  326 0.0 518
[...]
Bpa PDG94623.1  89.785  186 19  0   558 1   73  258 1.78e-115   325
Bpa PDL27043.1  89.247  186 20  0   558 1   73  258 2.75e-115   325
Bpa PDL27950.1  89.247  186 20  0   558 1   73  258 2.75e-115   325
[...]
Cpa PIS68069.1  51.145  131 62  2   399 10  1   130 1.77e-43    142
Cpa PIS68081.1  46.617  133 67  3   390 1   12  143 1.31e-37    127
Cpa PCF98276.1  48.819  127 58  3   375 1   24  145 1.85e-34    118
[...]</code></pre>
<p>This is “format 6” in blast, with tab separated columns in the default order <code>'qaccver saccver pident length mismatch gapopen qstart qend sstart send evalue bitscore'</code>. Please see the <a href="/blog/2018-02-22-nylander-awkblast.html/&lt;https://www.ncbi.nlm.nih.gov/books/NBK279684/&gt;">BLAST+ Manual</a> for further information.</p>
<p>For each query (<code>Apa</code>, <code>Bpa</code>, <code>Cpa</code> in the example above), the best hits are given as the first line for each query, and then listed in descending order. Keeping a number of hits in the output will inform us about the variation around the best hit, and can be very useful. But if we were interested in extracting only the top hit per query (ignoring the rest), how can we do that?</p>
<p>Here is where the example using AWK can help. The program <code>awk</code> (listening to commands written in the language AWK) is probably <em>the</em> work horse when it comes to reading structured data and is ideal for this particular problem.</p>
<p>A break down of the code shows that the script (<code>!x[$1]++</code>) consists of a single statement:</p>
<p><em>“If we can not add to the value for an existing index (the index being the string in the first column), then print the line”</em></p>
<p>The central part is utilizing a data structure called an associative array (or dictionary/hash), which is the <code>x[]</code> in the script (the name <code>x</code> is arbitrarily chosen). This array is a list of associated values given as key-value pairs. If you know the key (or index), you can very quickly get the value. One feature of the array is that the keys are strings, and need to be unique, whereas the values can be the same, or different for different keys. If we already have a value, say <code>10</code>, for a key <code>k</code>, we can increment that value by one by using the <code>++</code> operator as such: <code>x[k]++</code>. Now the value for <code>k</code> is <code>11</code>.</p>
<p>Another great feature is that the array can grow easily. If we try to increment a value for a key (<code>m</code>) that is not presently in the array, by using <code>x[m]++</code>, the key is created and then incremented. The argument <code>!</code> is a negation, so when we write <code>!x[$1]++</code>, we mean <em>“if we cannot add to the value for an existing key”</em>.</p>
<p>There are a number of built-in variables in <code>awk</code>, and perhaps most useful are the column numbers <code>$1</code>, <code>$2</code>, etc (until the last column <code>$NF</code>). For our problem, we are especially interested in what we have in column 1 (<code>$1</code>), since this is where we see the identity of the query.</p>
<p>The actual reading and printing is taken care of by <code>awk</code> itself. The program reads from standard in and prints to standard out by default, so we don’t have to add code in order to read or print the lines from our input.</p>
<p>So finally, in other words, <em>“read the input from standard in line by line, and if we haven’t seen the string in column one before, print the line to standard out, otherwise not”.</em></p>
<p>And this is exactly what we want to achieve: we only want to print the line with the first occurrence of <code>Apa</code> in the first column, since that is the top hit!</p>
<p>More on column data and <code>awk</code> later…</p>
<p><code>:wq</code></p>
<h2>Complete BLAST+ example</h2>
<ol>
<li>
<p>Get the software. Here we will use <a href="/blog/2018-02-22-nylander-awkblast.html/&lt;https://www.ncbi.nlm.nih.gov/books/NBK279671/&gt;">BLAST+</a> as an example. On a Debian-based Linux system, installation is as easy as</p>
<pre><code> sudo apt install ncbi-blast+</code></pre>
</li>
<li>
<p>Get some data (fasta files <code>db.fas</code>, 252K, 500 seqs, <code>query.fas</code>, 8K, 6 seqs)</p>
<pre><code> wget https://gist.github.com/nylander/a044690c63494674d9b4fb30ba27762d/raw/db.fas</code></pre>
<p>wget https://gist.github.com/nylander/a044690c63494674d9b4fb30ba27762d/raw/query.fas</p>
</li>
<li>
<p>Format the database</p>
<pre><code> makeblastdb -in db.fas -dbtype prot -parse_seqids</code></pre>
</li>
<li>
<p>Run a local blast search, saving output as “format 6” (tab separated, no headers). The blast suite of software allows you to decide the output fields. It might be time well spent to read up on how this is done so you can save your strength when parsing the output. See <code>blastx -help</code> and the <a href="/blog/2018-02-22-nylander-awkblast.html/&lt;https://www.ncbi.nlm.nih.gov/books/NBK279684/&gt;">Manual, Table C4</a> for description of options.</p>
<pre><code> blastx -query query.fas -db db.fas -out blast.out \
-outfmt "6 qseqid sacc stitle evalue bitscore pident qseq sseq" \
-max_target_seqs 10 \
-query_gencode 11 \
-num_threads 4</code></pre>
</li>
<li>
<p>Get the top hit per query</p>
<pre><code> awk '!x[$1]++' blast.out</code></pre>
</li>
</ol>

                </section>
            </section>
                </section>

    </div>

            <section id="footer" class="section bg-gray">
    <section class="container grid-lg">
        <p><a href="http://getgrav.org">Grav</a> was <i class="fa fa-code"></i> with <i class="fa fa-heart-o pulse "></i> by <a href="https://trilby.media">Trilby Media</a>.</p>
    </section>
</section>
    
        <div class="mobile-container">
        <div class="overlay" id="overlay">
            <div class="mobile-logo">
                <a href="/" class="navbar-brand mr-10">
  <svg xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" viewBox="0 0 504 140" clip-rule="evenodd"><path d="M235.83 71.56h-7.98c-1.2 0-2.2 1-2.2 2.2V89.1l-.15.13c-4.7 3.96-10.64 6.14-16.72 6.14-14.36 0-26.04-11.68-26.04-26.04s11.68-26.04 26.04-26.04c5.58 0 10.92 1.76 15.44 5.1.87.66 2.1.57 2.86-.2l5.7-5.7c.44-.44.67-1.05.63-1.68-.02-.62-.32-1.2-.82-1.6-6.76-5.35-15.2-8.3-23.8-8.3-21.18 0-38.42 17.23-38.42 38.4 0 21.2 17.24 38.42 38.42 38.42 10.93 0 21.4-4.7 28.7-12.9.35-.4.55-.93.55-1.47v-19.6c0-1.22-.98-2.2-2.2-2.2M502.8 34.44c-.4-.6-1.1-.98-1.84-.98h-8.7c-.87 0-1.66.52-2 1.32l-24.5 56.84-24.9-56.85c-.36-.8-1.15-1.3-2.02-1.3h-8.72c-.74 0-1.44.36-1.84.98-.4.62-.48 1.4-.17 2.1l30.2 68.85c.34.8 1.13 1.32 2 1.32h11c.88 0 1.67-.53 2.02-1.33l29.66-68.87c.3-.68.22-1.47-.2-2.1"/><path d="M388.68 34.77c-.35-.8-1.14-1.32-2-1.32h-11c-.88 0-1.67.53-2.02 1.33L344 103.64c-.3.68-.22 1.47.18 2.08.4.62 1.1 1 1.84 1h8.7c.86 0 1.66-.53 2-1.33l24.5-56.86 24.9 56.86c.36.8 1.15 1.32 2.02 1.32h8.72c.74 0 1.44-.38 1.84-1 .4-.62.47-1.4.17-2.1l-30.2-68.85zM309.2 81.52l.47-.22c8.68-4.2 14.28-13.1 14.28-22.67 0-13.88-11.3-25.18-25.17-25.18H266.9c-1.2 0-2.2 1-2.2 2.2v68.86c0 1.23 1 2.22 2.2 2.22h8c1.2 0 2.2-1 2.2-2.2V45.8h21.68c7.05 0 12.8 5.75 12.8 12.8 0 5.9-4 11-9.73 12.42-1.04.26-2.07.4-3.07.4h-7.98c-.83 0-1.6.46-1.96 1.2-.38.73-.3 1.62.2 2.3l22.6 30.87c.42.58 1.08.92 1.78.92h9.9c.84 0 1.6-.47 1.97-1.2.37-.75.3-1.64-.2-2.3l-15.9-21.7zM107.2 80.97c-7.26-4.8-11.4-8.85-15.02-16.1-2.47 4.97-8.24 12.37-17.96 18.2-4.86 15.1-27.96 44-35.43 39.9-2.22-1.2-2.64-2.8-2.15-4.45.54-4.13 9.08-13.62 9.08-13.62s.18 2 2.92 6.18c-3.6-11.2 5.96-25.03 8.5-29.73 3.98-1.27 4.27-6.4 4.27-6.4.26-7.9-3.28-13.63-6.7-17.05 2.46 3 3.25 7.54 3.37 11.7v.02c0 .47 0 .93 0 1.4-.12 3.43-1.16 8.18-3.38 8.18v.03c-2.28-.1-5.1.4-7.63 1.18l-5.6 1.34s2.98-.13 4.6 1.25c-1.8 2.9-5.78 6.53-10.22 8.58-6.45 3-8.3-2.96-5.03-6.84.8-.94 1.62-1.74 2.38-2.4-.5-.5-.8-1.2-.88-2.06 0 0 0 0 0-.02-.46-1.97-.2-4.54 2.6-8.62.54-.86 1.2-1.75 2-2.65.02-.04.04-.07.07-.1.03-.04.07-.08.1-.12.02-.02.04-.04.06-.06.2-.23.42-.45.64-.67 3.34-3.4 8.6-6.96 16.9-10.15C64.4 43.68 67.94 41 67.94 41c1.07-1.1 2.94-2.45 3.63-2.8-5.05-8.77-6.07-21.15-4.75-24.5-.1.2-.2.38-.3.57.5-1.14.83-1.5 1.34-2.1 1.38-1.64 6.06-2.5 7.74.96.9 1.84 1.06 4.23 1.03 6.02-3.7-.2-7.06 4.04-7.06 4.04s3.07-1.46 6.88-1.5c0 0 1 .9 2.28 2.56-1.7 3.2-4.52 10.02-2.5 17.16.35 1.4.86 2.62 1.5 3.65.02.05.04.1.07.14.05.07.1.13.14.2 3.37 5.06 9.54 5.66 9.54 5.66-2.9-1.45-5.27-3.76-6.8-6.56-.82-1.5-1.3-2.77-1.6-3.77-1.64-6.3.77-10 2.14-12.47 3.17-4.9 8.95-7.9 15.15-7.18 8.72 1 14.97 8.86 13.98 17.57-.6 5.32-3.78 9.72-8.15 12.12 1.05 2.84-.07 6.28-.07 6.28 2.64 3.32 2.76 5.23 2.67 7-3.36-.55-6.62 1.7-6.62 1.7s6.48-1.53 10.24 1.82c2.44 2.64 4.08 5 5.05 6.77 1.4 2.5 7.86 2.68 7.12 7.2-.74 4.5-5.68 4.53-13.4-.57M69.56 0C31.15 0 0 31.15 0 69.57c0 38.42 31.15 69.57 69.57 69.57 38.42 0 69.57-31.15 69.57-69.57C139.14 31.15 108 0 69.57 0M73.8 51.7c.8-.82.8-2.14 0-2.95-.82-.82-2.14-.82-2.95 0-.82.8-.82 2.13 0 2.94.8.8 2.13.8 2.95 0M66.45 53.15c-.82.8-.82 2.13 0 2.95.8.8 2.13.8 2.94 0 .8-.82.8-2.14 0-2.95-.82-.8-2.14-.8-2.95 0"/><path d="M79.23 54.23c-1.27-1.27-3.34-1.27-4.6 0l-2.72 2.7c-1.27 1.3-1.27 3.35 0 4.63l3 2.97c1.26 1.28 3.32 1.28 4.6 0l2.7-2.7c1.28-1.28 1.28-3.35 0-4.62l-2.97-2.97zM95.76 41.44c-2.15-2.57 1.87-7.25 4.4-4.46 4.64 5.15-2.25 7.04-4.4 4.46m9.24 2.7c3.45-6.56-1.42-10.4-4.77-13.53-5.36-5.03-10.7-7.2-16.8-.23-6.1 6.98-2.24 15.07 3.35 19.06 5.58 4 14.78 1.25 18.22-5.3"/></svg></a>
            </div>
            <nav class="overlay-menu">
                
<ul class="tree">
        
</ul>

            </nav>
        </div>
    </div>
    
    <script src="/assets/user/themes/quark/js/jquery.treemenu.js"></script>
<script src="/assets/user/themes/quark/js/site.js"></script>


</body>
</html>
